= IBM watsonx.ai

include::./includes/attributes.adoc[]

You can develop generative AI solutions with foundation models in IBM watsonx.ai. You can use prompts to generate, classify, summarize, or extract content from your input text. Choose from IBM models or open source models from Hugging Face. You can tune foundation models to customize your prompt output or optimize inferencing performance.

IMPORTANT: Supported only for IBM watsonx as a service on link:https://www.ibm.com/products/watsonx-ai/foundation-models[IBM Cloud].

== Using watsonx.ai

To employ watsonx.ai LLMs, integrate the following dependency into your project:

[source,xml,subs=attributes+]
----
<dependency>
    <groupId>io.quarkiverse.langchain4j</groupId>
    <artifactId>quarkus-langchain4j-watsonx</artifactId>
    <version>{project-version}</version>
</dependency>
----

If no other extension is installed, xref:ai-services.adoc[AI Services] will automatically utilize the configured watsonx dependency.

=== Configuration
To use the watsonx.ai dependency, you must configure some required values in the `application.properties` file.

---

==== Base URL
The `base-url` property depends on the region of the provided service instance, use one of the following values:

* Dallas: https://us-south.ml.cloud.ibm.com
* Frankfurt: https://eu-de.ml.cloud.ibm.com
* London: https://eu-gb.ml.cloud.ibm.com
* Tokyo: https://jp-tok.ml.cloud.ibm.com
* Sydney: https://au-syd.ml.cloud.ibm.com
* Toronto: https://ca-tor.ml.cloud.ibm.com

[source,properties,subs=attributes+]
----
quarkus.langchain4j.watsonx.base-url=https://us-south.ml.cloud.ibm.com
----

---

==== Project ID
To prompt foundation models in watsonx.ai, you need to pass the identifier of a project.

To get the ID of a project, complete the following steps:

1. Go to https://dataplatform.cloud.ibm.com/projects/?context=wx.
2. Open the project, and then click the Manage tab.
3. Copy the project ID from the Details section of the General page.

[source,properties,subs=attributes+]
----
quarkus.langchain4j.watsonx.project-id=23d...
----

NOTE: If you like, you can use the Space ID property with `quarkus.langchain4j.watsonx.space-id`

---

==== API Key
To use foundation models in IBM Watsonx.ai, you need an IBM Cloud API key. 

Follow these steps to generate one:

1. Go to https://cloud.ibm.com/iam/apikeys.
2. Click `Create +` button.
3. Provide a name and description for your new API key, then click `Create`.
4. Copy or securely save the API key.

[source,properties,subs=attributes+]
----
quarkus.langchain4j.watsonx.api-key=hG-...
----

---

=== Modes of Interaction

The `watsonx.ai` module provides two modes for interacting with large language models: `chat` and `generation`. These modes allow you to tailor interactions based on the complexity of your use case and the level of control you require over the prompt structure.

You can select the interaction mode using the property `quarkus.langchain4j.watsonx.mode`.

* **`chat`**: This mode abstracts the complexity of tagging by automatically formatting prompts (*default value*). 
* **`generation`**: In this mode, you must explicitly structure the prompts using the required model-specific tags. This provides full control over the format of the prompt but requires in-depth knowledge of the model being used. For best results, always refer to the documentation provided for each model to maximize the effectiveness of your prompts.

Each mode uses its own property namespace for customization:

* For `chat` mode the properties are under `quarkus.langchain4j.watsonx.chat-model`.
* For `generation` mode properties are under `quarkus.langchain4j.watsonx.generation-model`.

---

==== Chat Mode Example
The following example demonstrates how to configure and use `chat` mode:

[source,properties,subs=attributes+]
----
quarkus.langchain4j.watsonx.base-url=${BASE_URL}
quarkus.langchain4j.watsonx.api-key=${API_KEY}
quarkus.langchain4j.watsonx.project-id=${PROJECT_ID}
quarkus.langchain4j.watsonx.chat-model.model-id=mistralai/mistral-large
quarkus.langchain4j.watsonx.mode=chat // You can omit this property, as 'chat' is the default mode.
----

[source,java]
----
@RegisterAiService
public interface AiService {
    @SystemMessage("You are a helpful assistant")
    public String chat(@MemoryId String id, @UserMessage message);
}
----

---

==== Generation Mode Example
The following example demonstrates how to configure and use `generation` mode:

[source,properties,subs=attributes+]
----
quarkus.langchain4j.watsonx.base-url=${BASE_URL}
quarkus.langchain4j.watsonx.api-key=${API_KEY}
quarkus.langchain4j.watsonx.project-id=${PROJECT_ID}
quarkus.langchain4j.watsonx.generation-model.model-id=mistralai/mistral-large
quarkus.langchain4j.watsonx.mode=generation
----

[source,java]
----
@RegisterAiService(chatMemoryProviderSupplier = RegisterAiService.NoChatMemoryProviderSupplier.class)
public interface AiService {
    @SystemMessage("<s>[INST] You are a helpful assistant [/INST]</s>")
    @UserMessage("[INST] What is the capital of {capital}? [/INST]")
    public String askCapital(String capital);
}
----

NOTE: The `@SystemMessage` and `@UserMessage` annotations are joined by default with no separator (an empty string `""`). If you want to change this behavior, use the property `quarkus.langchain4j.watsonx.generation-model.prompt-joiner=<value>`.

=== Tools 

When using `chat` mode, you can extend the capabilities of your AI service by integrating tools. Tools allow the model to perform actions beyond text-based conversation, such as retrieving external information, searching online, or executing custom-defined tasks.

NOTE: Not all models available in `watsonx.ai` support tools. Before enabling tools, check the documentation of the specific model you are using.

==== Using Tools

You can register tools in your AI service by using the `@ToolBox` annotation or specifying them in `@RegisterAiService`. Tools can be either *built-in* or *custom*.

* **Built-in tools** - Predefined tools that provide common functionalities.
* **Custom tools** - You can create your own tools to integrate specific actions required by your application.  
  For more details on creating custom tools, refer to the 
  link:https://docs.quarkiverse.io/quarkus-langchain4j/dev/agent-and-tools.html[Agent and Tools] page.

==== Built-in Tools

The following built-in tools are available:

* `WebCrawlerTool` - Fetches the content of a single web page.
* `GoogleSearchTool` - Searches for online trends, news, current events, real-time information, or research topics.
* `WeatherTool` - Retrieves weather information for a specified city.

These tools can be used in two ways:

As **tools** within an AI service, using the `@ToolBox` annotation or `@RegisterAiService(tools = ...)`.

[source,java]
----
@RegisterAiService
public interface AiService {
    @SystemMessage("...")
    @ToolBox(WebCrawlerTool.class)
    public String chat(@UserMessage String message);
}
----

[source,java]
----
@RegisterAiService(tools = WebCrawlerTool.class)
public interface AiService {
    ...
}
----

**Injected** directly into your class using the `@Inject` annotation.

[source,java]
----
@Inject
WebCrawlerTool webCrawlerTool;
----

The built-in tools use a separate base URL that can be specified with `quarkus.langchain4j.watsonx.wx-base-url` property. If this property is not set, it will be automatically calculated based on `quarkus.langchain4j.watsonx.base-url`.

NOTE: Tools are supported *only in chat mode*.

== Text Extraction

The `TextExtraction` feature enables developers to extract text from high-value business documents stored in IBM Cloud Object Storage. Extracted text can be used for AI processing, key information identification, or further document analysis.

The API supports text extraction from the following file types:

* PDF
* GIF
* JPG
* PNG
* TIFF

The extracted text can be output in the following formats:

* JSON
* Markdown

=== Configuration

To enable `TextExtraction` in your application, configure the following properties:

[source,properties]
----
quarkus.langchain4j.watsonx.text-extraction.base-url=<base-url>
quarkus.langchain4j.watsonx.text-extraction.document-reference.connection=<connection-id>
quarkus.langchain4j.watsonx.text-extraction.document-reference.bucket-name=<bucket-name>
quarkus.langchain4j.watsonx.text-extraction.results-reference.connection=<connection-id>
quarkus.langchain4j.watsonx.text-extraction.results-reference.bucket-name=<bucket-name>
----

- **`base-url`**: The endpoint where the IBM Cloud Object Storage instance is deployed. To find the appropriate value, refer to the https://cloud.ibm.com/docs/cloud-object-storage?topic=cloud-object-storage-endpoints#regionalendpointtable1[IBM Cloud Object Storage endpoint table].  
- **`document-reference.connection`**: The connection asset ID containing credentials to access the source storage.  
- **`document-reference.bucket-name`**: The bucket where documents to be processed will be uploaded.  
- **`results-reference.connection`**: The connection asset ID containing credentials to access the output storage.  
- **`results-reference.bucket-name`**: The bucket where extracted text documents will be saved as new files.  

The `document reference` properties define the source storage for input and uloaded files, while the `results reference` properties specify where the extracted content is stored. Both can refer to the same bucket or different ones.

NOTE: For more information on how to get the connection parameter for the `document-reference` and `results-reference` you can refer to the documentation at this https://dataplatform.cloud.ibm.com/docs/content/wsj/analyze-data/fm-api-files.html?context=wx&audience=wdp[link].

=== Using Text Extraction

The `TextExtraction` class provides multiple methods for extracting text from documents. You can either extract text from an existing file in IBM Cloud Object Storage or upload a file and extract its content. To use `TextExtraction`, you need to inject an instance into your application. If multiple configurations are defined, you can specify the appropriate one using the `@ModelName` qualifier.

[source,java]
----
@Inject
TextExtraction textExtraction;

@Inject
@ModelName("custom")
TextExtraction customTextExtraction;
----

You can start the extraction process in two ways. 

First, if the document is already stored in IBM Cloud Object Storage, you can initiate the extraction by using the following method:

[source,java]
----
String extractionId = textExtraction.startExtraction("path/to/document.pdf", List.of(Language.ENGLISH));
----

Alternatively, if you're working with a local file, you can upload it and start the extraction process with:

[source,java]
----
File file = new File("path/to/document.pdf");
String extractionId = textExtraction.uploadAndStartExtraction(file, List.of(Language.ENGLISH));
----

After starting the extraction, you can check its status by calling:

[source,java]
----
TextExtractionResponse response = textExtraction.checkExtractionStatus(extractionId);
----

If you need to extract and retrieve the text immediately, you have two options.

You can either extract text from an existing file directly:

[source,java]
----
String extractedText = textExtraction.extractAndFetch("path/to/document.pdf", List.of(Language.ENGLISH));
----

Or upload the file and retrieve the extracted text immediately:

[source,java]
----
File file = new File("path/to/document.pdf");
String extractedText = textExtraction.uploadExtractAndFetch(file, List.of(Language.ENGLISH));
----


All extraction methods can also accept an `Options` object as parameter.

The `Options` object allows customization of extraction behavior, including:  

- Whether uploaded files should be deleted after processing.  
- Whether extracted text files should be removed from the results bucket after retrieval.  
- Overriding default properties values configured.  

[source,java]
----
Options options = 
    Options.create(List.of(ENGLISH))
        .removeOutputFile(true)
        .removeUploadedFile(true);

File file = new File("path/to/document.pdf");
String extractedText = textExtraction.uploadExtractAndFetch(file, options));
----

To perform Retrieval-Augmented Generation (RAG) on the extracted files in IBM Cloud Object Storage, you can use the following dependency to interact with the storage as it uses the S3 protocol:

[source,xml]
----
<dependency>
    <groupId>dev.langchain4j</groupId>
    <artifactId>langchain4j-document-loader-amazon-s3</artifactId>
    <version>...</version>
</dependency>
----

==== All configuration properties

include::includes/quarkus-langchain4j-watsonx.adoc[leveloffset=+1,opts=optional]